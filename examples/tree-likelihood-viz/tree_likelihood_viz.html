<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<title>Tree Likelihood Visualization</title>
<style type="text/css">
/*margin and padding on body element
  can introduce errors in determining
  element position and are not recommended;
  we turn them off as a foundation for YUI
  CSS treatments. */
body {
	margin:0;
	padding:0;
}
</style>
<script src="/lib/modernizr.min.js" type="text/javascript"></script>
<link rel="stylesheet" href="./lib/yui2/build/reset-fonts-grids/reset-fonts-grids.css" type="text/css">
<script type="text/javascript" src="./lib/yui3/build/yui/yui-min.js"></script>
<script type="text/javascript" src="./lib/stacktrace.js"></script>
<script type="text/javascript" src="./lib/nodes-ed.js"></script>
<style type="text/css">
	input {
		width: 8em;
	}
	.horiz_slider {
		margin-left: 2ex;
		margin-right: 2ex;
	}

	.yui3-js-enabled .yui3-joinedInputSlider-loading {
		display:none;
	}

	.yui3-dualInputSlider {
		margin-left: 2ex;
		margin-right: 2ex;
	}




</style>
</head>

<body class="yui3-skin-sam	yui-skin-sam">
<div id="doc" class="yui-t7">
<div id="hd" role="banner"><h1>Visualization of the likelihood of phylogenetic trees</h1></div>
<div id="bd" role="main">
	<div class="yui-g">
			<div class="yui-u first">
				  <header>
					<h2>Pattern probabilities</h2>
				  </header>
				  <canvas width="300" height="200" id="patternProbCanvas"></canvas>
			</div>
			<div class="yui-u">
				<h2>AB|CD</h2>
				<div id="treeABCanvasDiv">
				  <canvas width="300" height="200" id="treeABCanvas"></canvas>
				</div>
				<div id="treeABInputDiv">
				</div>
			</div>
	</div>

	<div class="yui-g">
		<div class="yui-u first">
			<h2>AC|BD</h2>
			<div id="treeACCanvasDiv">
				  <canvas width="300" height="200" id="treeACCanvas"></canvas>
			</div>
			<div id="treeACInputDiv">
			</div>
		</div>
		<div class="yui-u">
			<h2>AD|BC</h2>
			<div id="treeADCanvasDiv">
				  <canvas width="300" height="200" id="treeADCanvas"></canvas>
			</div>
			<div id="treeADInputDiv">
			</div>
		</div>
	</div>
</div>




<script type="text/javascript">
var DEBUGGING = true;
YUI({debug : DEBUGGING}).use("event-key", "widget", 'console', 'slider','node', 'joined-input-slider', function(Y) {

// load a console in debug mode, so we see the Y.log messages
if (DEBUGGING) {
	new Y.Console({height : 900}).render();
}

_createEdgeLengthSliders = function(srcNode, treeName) {
	var jInpSlider, i, edgj1Nd, edgeNameArray, edgeValueWidgets, edgeName, eid;
	edgeNameArray = ['A', 'B', 'C', 'D', 'Internal'];
		edgeValueWidgets = [];
	try {
		for (i = 0; i < edgeNameArray.length; ++i) {
			edgeName = edgeNameArray[i];
			eid = treeName + 'edge' + edgeName;
			srcNode.append('<input type="text" id="' + eid + '" class="yui3-joinedInputSlider-loading" value="0.05" />');
		}
		for (i = 0; i < edgeNameArray.length; ++i) {
			edgeName = edgeNameArray[i];
			eid = treeName + 'edge' + edgeName;
			edgeNd = Y.one('#' + eid);
			NdEjs.logObject(edgeNd, Y.log);
			jInpSlider = new Y.JoinedInputSlider({
				srcNode : edgeNd,
				value : edgeNd.get("value"),
				max : 0.5,
				min : 0.0,
				minorStep : 0.0001,
				majorStep : 0.01,
			});
			edgeValueWidgets[i] = jInpSlider;
		}
		for (i = 0; i < edgeValueWidgets.length; ++i) {
			edgeValueWidgets[i].render();
			edgeValueWidgets[i].focus();
		}
		return edgeValueWidgets;
	}
	catch (e) {
		NdEjs.logException(e, Y.log); 
		try {
			NdEjs.logException(e, Y.log);
		}
		catch (ee) {
			Y.log("EE = " + ee);
		}
		throw e;
	}
}

var FourLeafWidget = function(inputNode, canvasNd, treeName, treeIndex) {
	var i, inp;
	this.inputSrcNd = inputNode;
	this.treeName = treeName;
	this.inputArray = _createEdgeLengthSliders(srcNode, treeName);
	this.canvasNd = canvasNd;
	this.canvasDOMNd = Y.Node.getDOMNode(canvasNd);
	this.canvasContext = this.canvasDOMNd.getContext("2d");
	this._edgeLengthsToPlot = [null, null, null, null, null];
	this.leafNames = ['A', 'B', 'C', 'D'];
	this.treeIndex = treeIndex;
	//\todo these indices will control which tree we show (mapping of point on graph 
	//		to edge lengths and leafNames arrays
	this.leafUpLeftIndex = 0;

	this.canvasContext.font = "bold 12pt fixed-width";
	if (this.treeIndex == 1) { // AC|BD
		this.leafUpRightIndex = 1;
		this.leafDownLeftIndex = 2;
		this.leafDownRightIndex = 3;
		this.color = "#FF5555";
	}
	else if (this.treeIndex == 2) {
		this.leafUpRightIndex = 1;
		this.leafDownLeftIndex = 3;
		this.leafDownRightIndex = 2;
		this.color = "#0000FF";
	}
	else {
		this.leafUpRightIndex = 2;
		this.leafDownLeftIndex = 1;
		this.leafDownRightIndex = 3;
		this.color = "#00DD00";
	}
	this.canvasContext.strokeStyle = this.color;
	this.canvasContext.fillStyle = this.color;
	this.internalIndex = 4; // this is the same for all three trees
	this.X_ANGLE_MULTIPLIER = Math.sqrt(2);
	this.Y_ANGLE_MULTIPLIER = Math.sqrt(2);
	
	this._plot = function () {			
		this._calcCoordinates();
		this._repaintFromCoordinates();
	}
	this._repaintFromCoordinates = function () {
		var dim, nextLabel;
		this.canvasContext.clearRect(0, 0, this.canvasDOMNd.width, this.canvasDOMNd.height);
		this.canvasContext.beginPath();
		this.canvasContext.moveTo(this.leafUpLeftX, this.leafUpLeftY);
		this.canvasContext.lineTo(this.leftIntX, this.leftIntY);
		this.canvasContext.lineTo(this.leafDownLeftX, this.leafDownLeftY);
		this.canvasContext.moveTo(this.leftIntX, this.leftIntY);
		this.canvasContext.lineTo(this.rightIntX, this.rightIntY);
		this.canvasContext.moveTo(this.leafUpRightX, this.leafUpRightY);
		this.canvasContext.lineTo(this.rightIntX, this.rightIntY);
		this.canvasContext.lineTo(this.leafDownRightX, this.leafDownRightY);
		this.canvasContext.stroke();
		
		nextLabel = this.leafNames[this.leafUpLeftIndex];
		dim = this.canvasContext.measureText(nextLabel);
		this.canvasContext.fillText(nextLabel, this.leafUpLeftX - dim.width, this.leafUpLeftY);
		
		nextLabel = this.leafNames[this.leafUpRightIndex];
		dim = this.canvasContext.measureText(nextLabel);
		this.canvasContext.fillText(nextLabel, this.leafUpRightX, this.leafUpRightY);
		
		nextLabel = this.leafNames[this.leafDownLeftIndex];
		dim = this.canvasContext.measureText(nextLabel);
		this.canvasContext.fillText(nextLabel, this.leafDownLeftX - dim.width, this.leafDownLeftY + 12);
		
		nextLabel = this.leafNames[this.leafDownRightIndex];
		this.canvasContext.fillText(nextLabel, this.leafDownRightX, this.leafDownRightY + 12);
	}
	
	this._calcCoordinates = function () {
		var cnvsWidth, cnvsHeight, xScaler, yScaler;
		cnvsWidth = this.canvasDOMNd.width;
		cnvsHeight = this.canvasDOMNd.height;
		// denominator in Y is:
		//		a factor of 2.0 because we want room for 2 branches and labels (and the branches will be at 45-degrees)
		//		times  0.5 because the max branch length is 0.5
		yScaler = cnvsHeight/(2.0*.5); 
		// denominator in X has a 3.0 because we plot the internal horizontally,
		//		so the graph could be three edges wide.
		xScaler = cnvsWidth/(3.0*.5); 
		// left internal node always shows up at the same spot.
		this.leftIntX = cnvsWidth/3;
		this.leftIntY = cnvsHeight/2;
		// right internal node is directly to the right of the leftInt
		this.rightIntX = this.leftIntX + xScaler*(this._edgeLengthsToPlot[this.internalIndex]);
		this.rightIntY = this.leftIntY;
		// all other nodes are off at 45 degree angles, so we can deal with this
		//	 by rescaling our scalers...
		yScaler /= this.Y_ANGLE_MULTIPLIER;
		xScaler /= this.X_ANGLE_MULTIPLIER;
		//
		this.leafUpLeftEdgeLen = this._edgeLengthsToPlot[this.leafUpLeftIndex]
		this.leafUpLeftX = this.leftIntX - xScaler*this.leafUpLeftEdgeLen;
		this.leafUpLeftY = this.leftIntY - yScaler*this.leafUpLeftEdgeLen;
		this.leafDownLeftEdgeLen = this._edgeLengthsToPlot[this.leafDownLeftIndex]
		this.leafDownLeftX = this.leftIntX - xScaler*this.leafDownLeftEdgeLen;
		this.leafDownLeftY = this.leftIntY + yScaler*this.leafDownLeftEdgeLen;
		this.leafUpRightEdgeLen = this._edgeLengthsToPlot[this.leafUpRightIndex]
		this.leafUpRightX = this.rightIntX + xScaler*this.leafUpRightEdgeLen;
		this.leafUpRightY = this.rightIntY - yScaler*this.leafUpRightEdgeLen;
		this.leafDownRightEdgeLen = this._edgeLengthsToPlot[this.leafDownRightIndex]
		this.leafDownRightX = this.rightIntX + xScaler*this.leafDownRightEdgeLen;
		this.leafDownRightY = this.rightIntY + yScaler*this.leafDownRightEdgeLen;
	}

	this._updateEdgeLengthsFromInput = function() {
		var i;
		for (i = 0; i < this.inputArray.length; ++i) {
			this._edgeLengthsToPlot[i] = +(this.inputArray[i].get('value'));
		}
	}
	this.paint = function () {
		this._updateEdgeLengthsFromInput();
		this._plot();
	}

	this._afterEdgeLengthChanged = function (index, e) {
		this.paint();
	}

	for (i = 0; i < this.inputArray.length; ++i) {
		inp = this.inputArray[i];
		inp.after("valueChange", Y.bind(this._afterEdgeLengthChanged, this, i));
	}

}

	



	var treeNameArray = ['AB', 'AC', 'AD'], i, treeName, srcNode, cid, canvasNd, canvasDOMNd, treeWidgets;
	treeWidgets = [];
	for (i = 0; i < treeNameArray.length; ++i) {
		treeName = treeNameArray[i];
		cid = 'tree' + treeName + 'Canvas';
		Y.log('cid = ' + cid);
		canvasNd = Y.one('#' + cid)
		srcNode = Y.one("#tree" + treeName + 'InputDiv');
		
		flw = new FourLeafWidget(srcNode, canvasNd, treeName, i);
		treeWidgets[i] = flw;
	}
	
	for (i = 0; i < treeWidgets.length; ++i) {
		treeWidgets[i].paint();
	}

	return;
}
);
</script>

</body>
</html>


<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<title>Tree Likelihood Visualization</title>
<style type="text/css">
/*margin and padding on body element
  can introduce errors in determining
  element position and are not recommended;
  we turn them off as a foundation for YUI
  CSS treatments. */
body {
	margin:0;
	padding:0;
}
</style>
<script src="/lib/modernizr.min.js" type="text/javascript"></script>
<link rel="stylesheet" href="./lib/yui2/build/reset-fonts-grids/reset-fonts-grids.css" type="text/css">
<script type="text/javascript" src="./lib/yui3/build/yui/yui-min.js"></script>
<script type="text/javascript" src="./lib/stacktrace.js"></script>
<script type="text/javascript" src="./lib/nodes-ed-debug.js"></script>
<style type="text/css">
	input {
		width: 8em;
	}
	.horiz_slider {
		margin-left: 2ex;
		margin-right: 2ex;
	}

	.yui3-js-enabled .yui3-joinedInputSlider-loading {
		display:none;
	}

	.yui3-dualInputSlider {
		margin-left: 2ex;
		margin-right: 2ex;
	}




</style>
</head>

<body class="yui3-skin-sam	yui-skin-sam">
<div id="doc" class="yui-t7">
<div id="hd" role="banner"><h1>Visualization of the likelihood of phylogenetic trees</h1></div>
<div id="bd" role="main">
	<div class="yui-g">
			<div class="yui-u first">
				  <header>
					<h2>Pattern probabilities</h2>
				  </header>
				  <canvas width="300" height="200" id="patternProbCanvas"></canvas>
			</div>
			<div class="yui-u">
				<div id="treeABDiv"></div>
			</div>
	</div>

	<div class="yui-g">
		<div class="yui-u first">
			<div id="treeACDiv"></div>
		</div>
		<div class="yui-u">
			<div id="treeADDiv"></div>
		</div>
	</div>
</div>




<script type="text/javascript">
var DEBUGGING = true;
YUI({debug : DEBUGGING}).use('event-key', 
							 'widget', 
							 'console',
							 'slider',
							 'node',
							 'joined-input-slider',
							 'four-leaf-widget',
							 function(Y) {

// load a console in debug mode, so we see the Y.log messages
if (DEBUGGING) {
	new Y.Console({height : 900}).render();
}


FourLeafTreeCalculatorClass = function (config) {
	Y.log('FourLeafTreeCalculatorClass.ctor');
	this.topoIndex = config.topoIndex;

	this.leafUpLeftIndex = 0;
	if (this.treeIndex == 1) { // AC|BD
		this.leafUpRightIndex = 1;
		this.leafDownLeftIndex = 2;
		this.leafDownRightIndex = 3;
		this._calcIndexToStd = [0, 1, 4, 5, 2, 3, 6, 7];
	}
	else if (this.treeIndex == 2) {  // AD| BC
		this.leafUpRightIndex = 1;
		this.leafDownLeftIndex = 3;
		this.leafDownRightIndex = 2;
		this._calcIndexToStd = [0, 4, 2, 6, 1, 5, 3, 7];
	}
	else {  // AB | CD, which is the order that we do the pattern calculations in
		this.leafUpRightIndex = 2;
		this.leafDownLeftIndex = 1;
		this.leafDownRightIndex = 3;
		this._calcIndexToStd = [0, 1, 2, 3, 4, 5, 6, 7];
	}
	this.internalIndex = 4; // this is the same for all three trees
	this._calculatedValues = [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0];
	this._standardForm = [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0];

	this.edgeLenContainer = config.edgeLenContainer;
	this.initializer(config);
}
FourLeafTreeCalculatorClass.initializer = function(config) {
	Y.log('FourLeafTreeCalculatorClass.initializer');
}

function FourLeafTreeCalculator(config) {
	Y.log('FourLeafTreeCalculator.ctor');
	this.name = config.name;
	FourLeafTreeCalculator.superclass.constructor.apply(this, arguments);
}

FourLeafTreeCalculator = Y.extend(FourLeafTreeCalculator, FourLeafTreeCalculatorClass, {

	initializer : function(config) {
		Y.log('FourLeafTreeCalculator.initializer');
		this.edgeLenContainer.after("valueChange", Y.bind(this._afterEdgeChange, this));
	},
	
	_afterEdgeChange : function (e) {
		var edgeLenArray, probChangeArray,
			p0, p1,
			p00, p01, p10, p11,
			t0p0, t0p1, t1p0, t1p1,
			t00p0, t00p1, t10p0, t10p1, t01p0, t01p1, t11p0, t11p1,
			pn, pc;
		edgeLenArray = e.newVal;
		if (!Y.Lang.isArray(edgeLenArray)) {
			return;
		}
		Y.log('_afterEdgeChange for ' + this.name + ' edgeLenArray = [' + edgeLenArray[0] + ', '+ edgeLenArray[1] + ', '+ edgeLenArray[2] + ', '+ edgeLenArray[3] + ', '+ edgeLenArray[4] + ']')
		
		probChangeArray = edgeLenArray;
		//prob at "left" internal
		p1 = probChangeArray[this.leafUpLeftIndex]; 
		p0 = 1 - p1;
		//probs at "right" internal
		p01 = p0*probChangeArray[this.internalIndex];
		p00 = p0 - p01
		p10 = p1*probChangeArray[this.internalIndex];
		p11 = p1 - p10;
		// tip left down and the right intern
		pc = probChangeArray[this.leafDownLeftIndex];
		pn = 1 - pc;
		t0p1 = pc*p11 + pn*p01
		t0p0 = pc*p10 + pn*p00
		t1p1 = pn*p11 + pc*p01
		t1p0 = pn*p10 + pc*p00
		// tip left down, right up, and right internal
		pc = probChangeArray[this.leafUpRightIndex];
		pn = 1 - pc;
		t00p1 = t0p1*pc;
		t01p1 = t0p1*pn;
		t10p1 = t1p1*pc;
		t11p1 = t1p1*pn;
		t00p0 = t0p0*pn;
		t01p0 = t0p0*pc;
		t10p0 = t1p0*pn;
		t11p0 = t1p0*pc;
		// add right down last....
		pc = probChangeArray[this.leafDownRightIndex];
		pn = 1 - pc;
		this._calculatedValues[0] = t00p1*pc + t00p0*pn;
		this._calculatedValues[1] = t00p0*pc + t00p1*pn;
		this._calculatedValues[2] = t01p1*pc + t01p0*pn;
		this._calculatedValues[3] = t01p0*pc + t01p1*pn;
		this._calculatedValues[4] = t10p1*pc + t10p0*pn;
		this._calculatedValues[5] = t10p0*pc + t10p1*pn;
		this._calculatedValues[6] = t11p1*pc + t11p0*pn;
		this._calculatedValues[7] = t11p0*pc + t11p1*pn;
		for (i = 0; i < 8; ++i) {
			this._standardForm[i] = this._calculatedValues[this._calcIndexToStd[i]];
		}
		Y.log('probs =  [' + this._standardForm[0] + ', '+ this._standardForm[1] + ', '+ this._standardForm[2] + ', '+ this._standardForm[3] + ', ...')
		Y.log('   ' + this._standardForm[4] + ', '+ this._standardForm[5] + ', '+ this._standardForm[6] + ', '+ this._standardForm[7] + ']')
		//this.set('value', this._standardForm);
	}
});

	var treeNameArray = ['AB', 'AC', 'AD'], i, treeName , treeWidgets, flc;
	treeWidgets = [];
	for (i = 0; i < treeNameArray.length; ++i) {
		treeName = treeNameArray[i];
		parNd = Y.one('#' + 'tree' + treeName + 'Div');
		Y.log("parNd is " + parNd);
		flw = new Y.FourLeafWidget({treeName : treeName,
									treeIndex : i,
									parNd : parNd});

		flw.render(parNd);
		flc = new FourLeafTreeCalculator({name : treeName, 
								topoIndex : i, 
								edgeLenContainer : flw});
		treeWidgets[i] = flw;
	}
	return;
}
);
</script>

</body>
</html>

